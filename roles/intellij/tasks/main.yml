- name: "INTELLIJ | Creating directory for IntelliJ"
  file:
    path: "{{ ansible_env.HOME }}/Applications/intellij"
    state: directory

- name: "INTELLIJ | Determining latest release URL"
  script: latest.sh
  register: intellij_release

- name: "INTELLIJ | Downloading Intellij Ultimate"
  get_url:
    url: "{{ intellij_release.stdout_lines.0 }}"
    dest: "{{ ansible_env.HOME }}/Applications/intellij"
    timeout: 45
  register: intellij_bundle

- name: "INTELLIJ | Unpacking bundle"
  unarchive:
    src: "{{ intellij_bundle.dest }}"
    dest: "{{ ansible_env.HOME }}/Applications/intellij"
    remote_src: true

- name: "INTELLIJ | Cleaning up bundle"
  file:
    path: "{{ intellij_bundle.dest }}"
    state: absent

# This is ideal, but will timeout  -- https://github.com/ansible/ansible/issues/23864
#- name: "INTELLIJ | Downloading Intellij Ultimate"
#  unarchive:
#    src: "{{ intellij_release.stdout_lines.0 }}"
#    dest: "{{ ansible_env.HOME }}/Applications/intellij"
#    remote_src: true

- name: "INTELLIJ | Getting latest version (kinda)"
  command: bash -c "ls -lt {{ ansible_env.HOME }}/Applications/intellij | grep -v '^total' | head -n1 | awk '{printf $9}'"
  register: intellij_latest_download

- set_fact:
    intellij_location: "{{ ansible_env.HOME }}/Applications/intellij/{{ intellij_latest_download.stdout }}"

- name: "INTELLIJ | Creating desktop file for intellij app"
  template:
    src: entry.desktop
    dest: /usr/share/applications/intellij.desktop
  become: true
